# Development Dockerfile with multi-stage build

# Backend development stage
FROM python:3.11-slim AS backend-dev

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Poetry
RUN pip install poetry

# Configure Poetry
RUN poetry config virtualenvs.create true
RUN poetry config virtualenvs.in-project true

# Copy backend files
COPY backend/pyproject.toml backend/poetry.lock ./backend/

# Install dependencies
WORKDIR /app/backend
RUN poetry install --no-interaction --no-ansi

# Copy backend source
COPY backend/ ./

# Expose port
EXPOSE 8000

# Frontend development stage
FROM node:18-alpine AS frontend-dev

WORKDIR /app

# Set CI environment variable for pnpm
ENV CI=true

# Install pnpm
RUN npm install -g pnpm

# Copy frontend files
COPY frontend/package.json frontend/pnpm-lock.yaml ./frontend/

# Install dependencies
WORKDIR /app/frontend
RUN pnpm install --frozen-lockfile

# Copy frontend source
COPY frontend/ ./

# Expose port
EXPOSE 3000